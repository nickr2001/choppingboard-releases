name: Build NSIS Installer

on:
  release:
    types: [published]

jobs:
  build-installer:
    runs-on: windows-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set release variables
      - name: Set release variables
        shell: pwsh
        run: |
          Add-Content -Path $Env:GITHUB_ENV -Value "RELEASE_TAG=${{ github.event.release.tag_name }}"
          Add-Content -Path $Env:GITHUB_ENV -Value "RELEASE_ZIP=CB-${{ github.event.release.tag_name }}.zip"
          Add-Content -Path $Env:GITHUB_ENV -Value "RELEASE_FOLDER=CB-${{ github.event.release.tag_name }}"

      # 3Ô∏è‚É£ Debug environment variables
      - name: Debug environment variables
        shell: pwsh
        run: |
          Write-Host "RELEASE_TAG='$env:RELEASE_TAG'"
          Write-Host "RELEASE_ZIP='$env:RELEASE_ZIP'"
          Write-Host "RELEASE_FOLDER='$env:RELEASE_FOLDER'"

      # 4Ô∏è‚É£ Install GitHub CLI
      - name: Install GitHub CLI
        run: choco install gh -y

      # 5Ô∏è‚É£ Download release asset
      - name: Download release asset
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "$env:RELEASE_TAG" --repo "nickr2001/choppingboard-releases" --pattern "$env:RELEASE_ZIP"

      # 6Ô∏è‚É£ Fail early if zip missing
      - name: Check zip exists
        shell: pwsh
        run: |
          if (-Not (Test-Path "$env:RELEASE_ZIP")) {
            Write-Error "Release zip '$env:RELEASE_ZIP' not found. Aborting workflow."
            exit 1
          }

      # 7Ô∏è‚É£ Create build folder
      - name: Create build folder
        shell: pwsh
        run: New-Item -ItemType Directory -Force -Path build

      # 8Ô∏è‚É£ Extract the zip into the build folder
      - name: Extract the zip
        shell: pwsh
        run: Expand-Archive -Path "$env:RELEASE_ZIP" -DestinationPath "build"

      # 9Ô∏è‚É£ Debug extracted folder contents
      - name: Debug extracted folder
        shell: pwsh
        run: |
          Write-Host "Listing all files in build folder:"
          Get-ChildItem -Path "build" -Recurse | ForEach-Object { Write-Host $_.FullName }

      # üîü Check executable exists
      - name: Check executable exists
        shell: pwsh
        run: |
          $exePath = Join-Path -Path "build\$env:RELEASE_FOLDER" -ChildPath "ChoppingBoard.exe"
          if (-Not (Test-Path $exePath)) {
            Write-Error "Executable '$exePath' not found. Aborting workflow."
            exit 1
          }
          Write-Host "Found executable at $exePath"

      # 1Ô∏è‚É£1Ô∏è‚É£ Install NSIS
      - name: Install NSIS
        run: choco install nsis -y

      # 1Ô∏è‚É£2Ô∏è‚É£ Build NSIS installer using relative path with forward slashes and debug
      - name: Build NSIS installer
        shell: pwsh
        run: |
          $nsisPath = "${env:ProgramFiles(x86)}\NSIS\makensis.exe"

          # Change to build folder
          Set-Location -Path "build"

          # Convert RELEASE_FOLDER to forward slashes for NSIS
          $releaseFolderRelative = "$env:RELEASE_FOLDER" -replace '\\','/'
          Write-Host "Passing relative path to NSIS: $releaseFolderRelative"

          # Run NSIS and print debug info
          & "$nsisPath" /DAPPVER="$env:RELEASE_TAG" /DReleaseFolder="$releaseFolderRelative" ..\installer.nsi

      # 1Ô∏è‚É£3Ô∏è‚É£ Verify installer exists
      - name: Verify installer exists
        shell: pwsh
        run: dir

      # 1Ô∏è‚É£4Ô∏è‚É£ Upload installer to release
      - name: Upload installer to the release
        uses: softprops/action-gh-release@v2
        with:
          files: installer_ChoppingBoard_$env:RELEASE_TAG.exe
