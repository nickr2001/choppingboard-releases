name: Build NSIS Installer

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-installer:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download release zip
        uses: actions/download-release-asset@v1
        with:
          tag: ${{ github.event.release.tag_name }}
          file: CB-${{ github.event.release.tag_name }}.zip

      - name: Extract release zip
        run: |
          Expand-Archive -Path "CB-${{ github.event.release.tag_name }}.zip" -DestinationPath "build"
          # Move ChoppingBoard.exe up next to installer.nsi
          $exePath = Get-ChildItem -Path build -Recurse -Filter "ChoppingBoard.exe" | Select-Object -First 1
          if ($null -eq $exePath) {
            Write-Error "ChoppingBoard.exe not found in extracted archive"
            exit 1
          }
          Move-Item $exePath.FullName -Destination "$PWD\ChoppingBoard.exe"

      - name: Install NSIS
        run: choco install nsis -y

      - name: Build installer
        run: |
          $nsisPath = "${env:ProgramFiles(x86)}\NSIS\makensis.exe"
          & $nsisPath /DAPPVER="${{ github.event.release.tag_name }}" installer.nsi

      - name: Upload installer to release
        uses: softprops/action-gh-release@v2
        with:
          files: installer_ChoppingBoard_${{ github.event.release.tag_name }}.exe
