name: Build NSIS Installer

on:
  release:
    types: [published]

jobs:
  build-installer:
    runs-on: windows-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set release variables
      - name: Set release variables
        shell: pwsh
        run: |
          echo "RELEASE_TAG=${{ github.event.release.tag_name }}" >> $env:GITHUB_ENV
          echo "RELEASE_ZIP=CB-${{ github.event.release.tag_name }}.zip" >> $env:GITHUB_ENV

      # Step 3: Download release asset
      - name: Download release asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download "$env:RELEASE_TAG" `
            --repo "${{ github.repository }}" `
            --pattern "$env:RELEASE_ZIP"

      # Step 4: Extract zip and move exe to repo root
      - name: Extract and move exe
        shell: pwsh
        run: |
          Expand-Archive -Path "$env:RELEASE_ZIP" -DestinationPath build -Force
          $exe = Get-ChildItem -Path build -Recurse -Filter "ChoppingBoard.exe" | Select-Object -First 1
          if (-not $exe) {
            Write-Error "ChoppingBoard.exe not found in extracted archive!"
            exit 1
          }
          Copy-Item $exe.FullName . -Force
          Write-Host "Copied $($exe.FullName) to repo root"

      # Step 5: Install NSIS
      - name: Install NSIS
        run: choco install nsis -y

      # Step 6: Build NSIS installer
      - name: Build installer
        shell: pwsh
        run: |
          $nsisPath = "${env:ProgramFiles(x86)}\NSIS\makensis.exe"
          & $nsisPath /DAPPVER="$env:RELEASE_TAG" installer.nsi

      # Step 7: Upload installer to release
      - name: Upload installer
        uses: softprops/action-gh-release@v2
        with:
          files: installer_ChoppingBoard_${{ github.event.release.tag_name }}.exe
